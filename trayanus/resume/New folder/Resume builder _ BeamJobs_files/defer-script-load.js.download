document.addEventListener("DOMContentLoaded", () => {
  setTimeout(initScripts, 5000);
});
document.addEventListener("scroll", initScriptsOnEvent);
document.addEventListener("mousemove", initScriptsOnEvent);
document.addEventListener("touchstart", initScriptsOnEvent);
document.addEventListener("keydown", initScriptsOnEvent);

function initScriptsOnEvent(event) {
  initScripts();
  event.currentTarget.removeEventListener(event.type, initScriptsOnEvent);
}

let haveAsyncScriptsBeenLoaded = false;

function initScripts() {
  if (haveAsyncScriptsBeenLoaded) {
    return;
  }
  haveAsyncScriptsBeenLoaded = true;

  // If we let this run when Scully is generating the HTML, there's a chance
  // the 3rd party scripts get loaded in twice. Once when the HTML is being
  // generated, and another time when defer-script-load is called from the
  // generated page being served in production. This method is copied
  // from Scully's source:
  // https://github.com/scullyio/scully/blob/main/libs/ng-lib/src/lib/utils/isScully.ts
  const isScullyRunning = () => window && window["ScullyIO"] === "running";
  if (isScullyRunning()) {
    return;
  }

  _initFathomAnalytics();
}

function _initFathomAnalytics() {
  // See this for documentation: https://usefathom.com/docs/script/embed
  const script = document.createElement("script");
  script.type = "text/javascript";
  script.defer = true;
  script.src = "https://cdn.usefathom.com/script.js";
  // We only have 1 Fathom environment, so no need to replace this site ID
  // at build time.
  script.setAttribute("data-site", "ONIKCHGS");
  script.setAttribute("data-spa", "auto");

  document.head.appendChild(script);
}
